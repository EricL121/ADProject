@model ADProject.Models.Recipe

@{
    ViewData["Title"] = "Create";
    int userId = (int)ViewData["UserId"];
}

<h1>Create</h1>

<h4>Recipe</h4>
<hr />
<div id="create"></div>

<div>
    <a asp-action="Index">Back to List</a>
</div>
@* <form method="post" enctype="multipart/form-data" asp-controller="Recipes" asp-action="FileUpload">
    <dl>
        <dt>
            <label>Upload</label>
        </dt>
        <dd>
            <input type="file" name="FormFile" id="FormFile">

        </dd>
    </dl>
    <input class="btn" type="submit" value="Upload" />
</form> *@

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@functions{
    public string GetAntiXsrfRequestToken()
    {
        return Xsrf.GetAndStoreTokens(Context).RequestToken;
    }
}

<input type="hidden" id="RequestVerificationToken" 
       name="RequestVerificationToken" value="@GetAntiXsrfRequestToken()">

<!-- React JS -->
<script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

<!-- axios -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js" integrity="sha512-bZS47S7sPOxkjU/4Bt0zrhEtWx0y0CRkhEp8IckzK+ltifIIE9EMIMTuT/mEzoIMewUINruDBIR/jJnbguonqQ==" crossorigin="anonymous"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
    .create-form-header {
        text-align: center;
    }

    hr {
        border-color: black;
    }

    textarea {
        min-height: 200px;
        resize: none;
    }

    .icon-button {
        background-color: Transparent;
        background-repeat:no-repeat;
        border: none;
        cursor:pointer;
        overflow: hidden;
        outline:none;
    }
</style>

<script type="text/babel">
    class Create extends React.Component {
        render() {
            return (
                <div className="px-2">
                    <h2 className="create-form-header">Create New Recipes</h2>
                    <hr />
                    <div className="row justify-content-center">
                        <form enctype="multipart/form-data" onSubmit={this.submitHandler}>

                            <div className="row">
                                <div className="col-sm">
                                    <div className="form-group">
                                        <label className="control-label font-weight-bold">Recipe Name</label>
                                        <input type="text" className="form-control" name="Title" value={this.state.Title} onChange={this.handleChange} />
                                    </div>
                                    <div className="form-group">
                                        <label className="control-label font-weight-bold">Cover Image</label>
                                        <input type="file" onChange={this.onMainMediaUrlChange} />
                                        {this.state.MainMediaUrl && <img src={`@Url.Content("~/${this.state.MainMediaUrl}")`} alt="MainMediaUrl" />}
                                        <button className="btn btn-secondary" value="upload" onClick={this.onMainMediaUpload}>
                                            Upload!
                                        </button>
                                    </div>
                                    <div className="form-group">
                                        <label className="control-label font-weight-bold">Description</label>
                                        <textarea type="text" className="form-control" name="Description" value={this.state.Description} onChange={this.handleChange}></textarea>
                                    </div>
                                </div>
                                <div className="col-sm">
                                    <div className="form-group">
                                        <label className="control-label font-weight-bold">Duration (Minutes)</label>
                                        <input type="number" className="form-control" name="DurationInMins" value={this.state.DurationInMins} onChange={this.handleChange} />
                                    </div>
                                    <div className="form-group">
                                        <label className="control-label font-weight-bold">Calories</label>
                                        <input type="number" className="form-control" name="Calories" value={this.state.Calories} onChange={this.handleChange} />
                                    </div>
                                    <div className="form-group">
                                        <label className="control-label font-weight-bold">Serving Size</label>
                                        <input type="number" className="form-control" name="ServingSize" value={this.state.ServingSize} onChange={this.handleChange} />
                                    </div>
                                    <div className="row">
                                        <div className="col-sm">
                                            <div className="row justify-content-between">
                                                <div className="col-sm">
                                                    <label className="control-label font-weight-bold">Allergen Tags</label>
                                                </div>
                                            </div>
                                            <div className="row justify-content-between">
                                                <div className="col-sm">
                                                    {this.state.RecipeTags.map((tag, index) => {
                                                        if(tag.IsAllergenTag) {
                                                            return (
                                                                <div className="row mb-1" key={index}>
                                                                    <div className="col-sm-10">
                                                                        <input type="text" className="form-control" onChange={() => this.handleAllergenTagChange(event, index)} value={tag.Tag.Warning} />
                                                                    </div>
                                                                    <div className="col-sm-2">
                                                                        <button type="button" className="icon-button" onClick={() => this.removeAllergenTag(index)}>
                                                                            <i class="fa fa-times" aria-hidden="true"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            )
                                                        }
                                                    })}
                                                </div>
                                            </div>
                                            <div className="row mb-2">
                                                <div className="col-sm-6">
                                                    <button type="button" className="icon-button" onClick={this.addAllergenTag}>
                                                        <i class="fa fa-plus" aria-hidden="true">Add Allergen Tag</i>
                                                    </button>
                                                </div>
                                                <div className="col-sm-6">
                                                    <button className="icon-button" type="button" onClick={this.generateAllergenTags}>
                                                        <i class="fa fa-plus-square" aria-hidden="true">Generate Allergen Tags</i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="row mb-5">
                                        <div className="col-sm">
                                            <label className="control-label font-weight-bold">Tags</label>
                                            {this.state.RecipeTags.map((tag, index) => {
                                                if(!tag.IsAllergenTag) {
                                                    return (
                                                        <div className="row mb-1" key={index}>
                                                            <div className="col-sm-10">
                                                                <input type="text" className="form-control" onChange={() => this.handleTagChange(event, index)} value={tag.Tag.TagName} />
                                                            </div>
                                                            <div className="col-sm-2">
                                                                <button type="button" className="icon-button" onClick={() => this.removeTag(index)}>
                                                                    <i class="fa fa-times" aria-hidden="true"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    )
                                                }
                                            })}
                                            <button type="button" className="icon-button" onClick={this.addTag}>
                                                <i class="fa fa-plus" aria-hidden="true">Add Tags</i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="row">
                                <div className="col-sm">
                                    <label className="control-label font-weight-bold">Ingredients</label>
                                </div>
                            </div>

                            <div className="row">
                                <div className="col-sm">
                                    {this.state.RecipeIngredients.map((element, index) => {
                                        return(
                                            <div className="row" key={index}>
                                                <div className="form-group col-sm-6">
                                                    <input type="text" className="form-control" placeholder="Ingredient" id={`ingredient-name-${index}`} name="ingredient-name" onChange={() => this.handleIngredientChange(index)} value={element.Ingredient} />
                                                </div>
                                                <div className="form-group col-sm-2">
                                                    <input type="number" className="form-control" placeholder="Quantity" id={`ingredient-qty-${index}`} name="ingredient-qty" onChange={() => this.handleIngredientChange(index)} value={element.Quantity} />
                                                </div>
                                                <div className="form-group col-sm-3">
                                                    <input type="text" className="form-control" placeholder="Unit" id={`ingredient-unit-${index}`} name="ingredient-unit" onChange={() => this.handleIngredientChange(index)} value={element.UnitOfMeasurement} />
                                                </div>
                                                <div className="col-sm-1">
                                                    <button type="button" className="icon-button" onClick={() => this.removeIngredient(index)}>
                                                        <i class="fa fa-times" aria-hidden="true"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>

                            <div className="row">
                                <div className="col-sm mb-5">
                                    <button className="icon-button" type="button" onClick={this.addIngredient}>
                                        <i class="fa fa-plus" aria-hidden="true">Add ingredient</i>    
                                    </button>
                                </div>
                            </div>

                            <div className="row">
                                <div className="col-sm">
                                    {this.state.RecipeSteps.map((element, index) => {
                                        return(
                                            <div key={index}>
                                                <div className="row">
                                                    <div className="col-sm font-weight-bold">
                                                        Step {index + 1}
                                                    </div>
                                                </div>
                                                <div className="row">
                                                    <div className="form-group col-sm-6">
                                                        <label className="control-label">Step Image</label>
                                                        <input type="file" onChange={() => this.onStepUrlChange(event, index)} />
                                                        {element.MediaFileUrl && <img src={`@Url.Content("~/${element.MediaFileUrl}")`} alt="MainMediaUrl" />}
                                                        <button className="btn btn-secondary" value="upload" onClick={() => this.onStepMediaUpload(event, index)}>
                                                            Upload!
                                                        </button>
                                                    </div>
                                                    <div className="form-group col-sm-5">
                                                        <textarea type="text" placeholder="Step Instructions" className="form-control" name="step-instruction" onChange={() => this.handleStepChange(event, index)}  value={element.TextInstructions}></textarea>
                                                    </div>
                                                    <div className="col-sm-1">
                                                        <button type="button" className="icon-button" onClick={() => this.removeStep(index)}>
                                                            <i class="fa fa-times" aria-hidden="true"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>

                            <div className="row ">
                                <div className="col-sm">
                                    <button className="icon-button" type="button" onClick={this.addStep}>
                                        <i class="fa fa-plus" aria-hidden="true">Add Step</i>
                                    </button>
                                </div>
                            </div>

                            <div className="row mt-3">  
                                <div className="col-sm-2 offset-sm-10">
                                    <input type="submit" value="Create" className="btn btn-primary" />
                                </div>
                            </div>

                        </form>
                    </div>
                </div>
            )
        }

        onStepUrlChange = (event, index) => {
            console.log(event.target.files[0].name);
            this.setState(state => {
                const RecipeSteps = state.RecipeSteps;
                RecipeSteps[index].MediaFileUrl = "";
                RecipeSteps[index].MediaSelectedFile = event.target.files[0];

                return {
                    RecipeSteps
                }
            })
        }

        onStepMediaUpload = async (event, index) => {
            event.preventDefault();
            const file = this.state.RecipeSteps[index].MediaSelectedFile;

            const formData = new FormData();
            formData.append("formFile", file);
            formData.append("fileName", file.name);

            try {
                const { data: { fileUrl } } = await axios.post("/Recipes/FileUpload", formData);
                console.log(fileUrl);

                this.setState(state => {
                    const RecipeSteps = state.RecipeSteps;
                    RecipeSteps[index].MediaFileUrl = fileUrl.trim();
                    console.log(RecipeSteps);
                    return {
                        RecipeSteps
                    }
                });
            } catch(error) {
                alert("Error uploading step image");
            }
        }

        onMainMediaUpload = async (event) => {
            event.preventDefault();
            const file = this.state.MainSelectedFile;

            const formData = new FormData();
            formData.append("formFile", file);
            formData.append("fileName", file.name);

            try {
                const { data: { fileUrl } } = await axios.post("/Recipes/FileUpload", formData);
                console.log(fileUrl);

                this.setState({
                    MainMediaUrl: fileUrl.trim()
                });
            } catch(error) {
                alert("Error uploading main image");
            }
        }

        onMainMediaUrlChange = (event) => {
            console.log(event.target.files[0].name)
            this.setState({
                MainMediaUrl: "",
                MainSelectedFile: event.target.files[0]
            })
        }

        constructor(props) {
            super(props);
            this.state = {
                Title: "Vanilia Cake",
                Description: "",
                UserId: "@Html.Raw(userId)",
                DurationInMins: 0,
                Calories: 0,
                ServingSize: 1,
                IsPublished: true,

                MainMediaUrl: "",
                MainSelectedFile: null,

                RecipeIngredients: [{
                    Ingredient: "large eggs, room temperature",
                    Quantity: 4,
                    UnitOfMeasurement: "egg",
                },
                {
                    Ingredient: "cups sugar",
                    Quantity: 2,
                    UnitOfMeasurement: "cups",
                },
                {
                    Ingredient: "vanilia extract",
                    Quantity: 1,
                    UnitOfMeasurement: "teaspoon",
                },
                {
                    Ingredient: "all-purpose flour",
                    Quantity: 2.25,
                    UnitOfMeasurement: "cups",
                },
                {
                    Ingredient: "baking powder",
                    Quantity: 2.25,
                    UnitOfMeasurement: "cups",
                },
                {
                    Ingredient: "2% milk",
                    Quantity: 1.25,
                    UnitOfMeasurement: "cups",
                },
                {
                    Ingredient: "butter, cubed",
                    Quantity: 10,
                    UnitOfMeasurement: "tablespons",
                },],
                RecipeSteps: [{
                    TextInstructions: "I'm lazy",
                    MediaFileUrl: "",
                    MediaSelectedFile: null,
                }, {
                    TextInstructions: "So I hard code",
                    MediaFileUrl: "",
                    MediaSelectedFile: null,
                }],
                RecipeTags: [{
                    IsAllergenTag: true,
                    Tag: {
                        TagName: "",
                        Warning: "",
                    }
                }, {
                    IsAllergenTag: false,
                    Tag: {
                        TagName: "",
                        Warning: ""
                    }
                }],
            };
        }

        generateAllergenTags = (event) => {
            event.preventDefault();
            const ingredient = [...this.state.RecipeIngredients];
            console.log(ingredient);
            this.fetchAllergenTags(ingredient, this.setAllergenTags);
        }

        submitHandler = (event) => {
            event.preventDefault();
            const toSubmit = this.generateJson();
            console.log(toSubmit);
            this.postRecipe(toSubmit);
        }

        generateJson = () => {
            var RecipeSteps = this.state.RecipeSteps
                .filter(step => step.TextInstructions.trim() !== "")
                .map((step, index) => {
                    delete step.MediaSelectedFile;
                    return {
                        ...step, 
                        StepNumber: index + 1
                    }
                });
            
            var RecipeIngredients = this.state.RecipeIngredients
                .filter(ingredient => ingredient.Ingredient.trim() !== "");

            var RecipeTags = this.state.RecipeTags
                .filter(allergenTag => allergenTag.Tag.Warning.trim() !== "");

            var state = {...this.state};
            delete state.MainSelectedFile;
            const toSubmit = {
                ...state,
                RecipeSteps,
                RecipeIngredients,
                RecipeTags
            }
            return toSubmit;
        }

        postRecipe = (toSubmit) => {
            let xhr = new XMLHttpRequest();
            xhr.open("POST", "/Recipes/Create");
            xhr.setRequestHeader("Content-Type", "application/json; charset=utf8");

            xhr.setRequestHeader("RequestVerificationToken",
                    document.getElementById('RequestVerificationToken').value);

            xhr.onreadystatechange = function () {
                if (this.readyState === XMLHttpRequest.DONE) {
                    // Request for recipe list page if add recipe is successful
                    if (this.status === 200) {
                        var url = window.location.href;
                        var redirectUrl = url.split("/");
                        redirectUrl.pop();
                        window.location.assign(redirectUrl.join("/"));
                    } else {
                        alert("Error adding recipe");
                    }
                }
            };

            xhr.send(JSON.stringify(toSubmit));
        }

        fetchAllergenTags = (ingredient, callback) => {
            let xhr = new XMLHttpRequest();
            xhr.open("POST", "/Recipes/GenerateAllergenTag");
            xhr.setRequestHeader("Content-Type", "application/json; charset=utf8");

            xhr.setRequestHeader("RequestVerificationToken",
                    document.getElementById('RequestVerificationToken').value);

            xhr.onreadystatechange = function () {
                if (this.readyState === XMLHttpRequest.DONE) {
                    // Get tags from flask ML
                    if (this.status === 200) {
                        const { tags } = JSON.parse(this.response);
                        console.log(tags);
                        callback(tags);
                    } else {
                        alert("Error generate tags");
                    }
                }
            };

            xhr.send(JSON.stringify(ingredient));
        }

        setAllergenTags = (tags) => {
            this.setState(state => {
                const RecipeTags = [...state.RecipeTags, ...JSON.parse(tags)]
                    .filter(r => {
                        return r.Tag.Warning.trim() !== "" || !r.IsAllergenTag;
                    });

                return {
                    RecipeTags
                }
            })
            console.log(this.state.RecipeTags);
        }

        removeAllergenTag = (index) => {
            this.setState(state => {
                const RecipeTags = state.RecipeTags;
                RecipeTags.splice(index, 1);
                return {
                    RecipeTags
                }
            })
        }

        addAllergenTag = () => {
            this.setState(state => {
                const RecipeTags = [...state.RecipeTags, {
                    IsAllergenTag: true,
                    Tag: {
                        TagName: "",
                        Warning: "",
                    }
                }];
                return {
                    RecipeTags
                }
            })
        }

        handleAllergenTagChange = (event, index) => {
            const newTag = event.target.value;
            this.setState(state => {
                const RecipeTags = state.RecipeTags;
                RecipeTags[index] = {
                    IsAllergenTag: true,
                    Tag: {
                        TagName: newTag,
                        Warning: newTag,
                    }
                }
                return {
                    RecipeTags
                }
            })
        }

        handleTagChange = (event, index) => {
            const newTag = event.target.value;
            this.setState(state => {
                const RecipeTags = state.RecipeTags;
                RecipeTags[index] = {
                    IsAllergenTag: false,
                    Tag: {
                        TagName: newTag,
                        Warning: newTag,
                    }
                }
                return {
                    RecipeTags
                }
            })
        }

        removeTag = (index) => {
            this.setState(state => {
                const RecipeTags = state.RecipeTags;
                RecipeTags.splice(index, 1);
                return {
                    RecipeTags
                }
            })
        }

        addTag = () => {
            this.setState(state => {
                const RecipeTags = [...state.RecipeTags, {
                    IsAllergenTag: false,
                    Tag: {
                        TagName: "",
                        Warning: "",
                    }
                }];
                return {
                    RecipeTags
                }
            })
        }

        handleChange = (event) => {
            const { name, value } = event.target;
            this.setState({
                [name]: value
            });
        }

        addIngredient = () => {
            this.setState(state => {
                const RecipeIngredients = [...state.RecipeIngredients, {
                    Ingredient: "",
                    Quantity: 0,
                    UnitOfMeasurement: "",
                }];
                return {
                    RecipeIngredients,
                }
            })
        }

        removeIngredient = (index) => {
            this.setState(state => {
                const RecipeIngredients = state.RecipeIngredients;
                RecipeIngredients.splice(index, 1);
                return {
                    RecipeIngredients,
                }
            })
        }

        handleIngredientChange = (index) => {
            const Ingredient = document.getElementById(`ingredient-name-${index}`).value;
            const Quantity = document.getElementById(`ingredient-qty-${index}`).value;
            const Unit = document.getElementById(`ingredient-unit-${index}`).value;
            this.setState(state => {
                const RecipeIngredients = state.RecipeIngredients;
                RecipeIngredients[index] = {
                    Ingredient,
                    Quantity,
                    Unit
                }
                return {
                    RecipeIngredients
                };
            })
        }

        addStep = () => {
            this.setState(state => {
                const RecipeSteps = [...state.RecipeSteps, {
                    TextInstructions: "",
                    MediaFileUrl: "",
                    MediaSelectedFile: null,
                }];
                return {
                    RecipeSteps,
                }
            });
        }

        removeStep = (index) => {
            this.setState(state => {
                const RecipeSteps = state.RecipeSteps;
                RecipeSteps.splice(index, 1);
                return {
                    RecipeSteps,
                }
            });
        }

        handleStepChange = (event, index) => {
            const TextInstructions = event.target.value;
            this.setState(state => {
                const RecipeSteps = state.RecipeSteps;
                const oldStep = RecipeSteps[index]
                RecipeSteps[index] = {
                    ...oldStep,
                    TextInstructions
                }
                return {
                    RecipeSteps
                };
            })
        }
    }

    ReactDOM.render(<Create />, document.querySelector("#create"));
</script>