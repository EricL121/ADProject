@model ADProject.Models.Recipe

@{
    ViewData["Title"] = "Edit";
    int userId = (int)ViewData["UserId"];
    string recipe = (string)ViewData["Recipe"];
}

<h1>Edit</h1>

<h4>Recipe</h4>
<hr />
<div id="edit"></div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@functions{
    public string GetAntiXsrfRequestToken()
    {
        return Xsrf.GetAndStoreTokens(Context).RequestToken;
    }
}

<input type="hidden" id="RequestVerificationToken"
       name="RequestVerificationToken" value="@GetAntiXsrfRequestToken()">

<!-- React JS -->
<script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

<!-- axios -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js" integrity="sha512-bZS47S7sPOxkjU/4Bt0zrhEtWx0y0CRkhEp8IckzK+ltifIIE9EMIMTuT/mEzoIMewUINruDBIR/jJnbguonqQ==" crossorigin="anonymous"></script>

<script type="text/babel">
    class Edit extends React.Component {
        render() {
            return (
                <div className="row">
                    <form onSubmit={this.submitHandler}>
                            <div className="form-group">
                                <label className="control-label">Title</label>
                                <input type="text" className="form-control" name="Title" value={this.state.Title} onChange={this.handleChange} />
                            </div>
                            <div className="form-group">
                                <label className="control-label">Cover Image</label>
                                <input type="file" onChange={this.onMainMediaUrlChange} />
                                {this.state.MainMediaUrl && <img src={`@Url.Content("~/${this.state.MainMediaUrl}")`} alt="MainMediaUrl" />}
                                <button className="btn btn-secondary" value="upload" onClick={this.onMainMediaUpload}>
                                    Upload!
                                </button>
                            </div>
                            <div className="form-group">
                                <label className="control-label">Description</label>
                                <input type="text"className="form-control" name="Description" value={this.state.Description} onChange={this.handleChange} />
                            </div>
                            <div className="form-group">
                                <label className="control-label">DurationInMins</label>
                                <input type="number" className="form-control" name="DurationInMins" value={this.state.DurationInMins} onChange={this.handleChange} />
                            </div>
                            <div className="form-group">
                                <label className="control-label">Calories</label>
                                <input type="number" className="form-control" name="Calories" value={this.state.Calories} onChange={this.handleChange} />
                            </div>
                            <div className="form-group">
                                <label className="control-label">ServingSize</label>
                                <input type="number" className="form-control" name="ServingSize" value={this.state.ServingSize} onChange={this.handleChange} />
                            </div>

                            {this.state.RecipeSteps.map((element, index) => {
                                return(
                                    <div key={index}>
                                        <div>Step {index + 1}</div>
                                        <div className="form-group">
                                            <label className="control-label">TextInstructions</label>
                                            <input type="text" className="form-control" name="step-instruction" onChange={() => this.handleStepChange(event, index)}  value={element.TextInstructions} />
                                        </div>
                                        <div className="form-group">
                                            <label className="control-label">Step Image</label>
                                            <input type="file" onChange={() => this.onStepUrlChange(event, index)} />
                                            {element.MediaFileUrl && <img src={`@Url.Content("~/${element.MediaFileUrl}")`} alt="MainMediaUrl" />}
                                            <button className="btn btn-secondary" value="upload" onClick={() => this.onStepMediaUpload(event, index)}>
                                                Upload!
                                            </button>
                                        </div>
                                        <button type="button" className="btn btn-danger" onClick={() => this.removeStep(index)}>Remove Step</button>
                                    </div>
                                )
                            })}
                            <button className="btn btn-secondary" type="button" onClick={this.addStep}>Add Steps</button>

                            {this.state.RecipeIngredients.map((element, index) => {
                                return(
                                    <div key={index}>
                                        <div>Ingredient {index + 1}</div>
                                        <div className="form-group">
                                            <label className="control-label">Ingredient</label>
                                            <input type="text" id={`ingredient-name-${index}`} name="ingredient-name" onChange={() => this.handleIngredientChange(index)} value={element.Ingredient} />
                                        </div>
                                        <div className="form-group">
                                            <label className="control-label">Quantity</label>
                                            <input type="number" id={`ingredient-qty-${index}`} name="ingredient-qty" onChange={() => this.handleIngredientChange(index)} value={element.Quantity} />
                                        </div>
                                        <div className="form-group">
                                            <label className="control-label">UnitOfMeasurement</label>
                                            <input type="text" id={`ingredient-unit-${index}`} name="ingredient-unit" onChange={() => this.handleIngredientChange(index)} value={element.UnitOfMeasurement} />
                                        </div>
                                        <button type="button" className="btn btn-danger" onClick={() => this.removeIngredient(index)}>Remove Ingredient</button>
                                    </div>
                                )
                            })}
                            <button className="btn btn-secondary" type="button" onClick={this.addIngredient}>Add Ingredient</button>

                            <label className="control-label">Allergen Tags</label>
                            <button className="btn btn-primary" type="button" onClick={this.generateAllergenTags}>Generate Allergen Tag</button>
                            {this.state.RecipeTags.map((tag, index) => {
                                if(tag.IsAllergenTag) {
                                    return (
                                        <div key={index}>
                                            <input type="text" onChange={() => this.handleAllergenTagChange(event, index)} value={tag.Tag.Warning} />
                                            <button type="button" className="btn btn-danger" onClick={() => this.removeAllergenTag(index)}>X</button>
                                        </div>
                                    )
                                }
                            })}
                            <button type="button" className="btn btn-primary" onClick={this.addAllergenTag}>Add Allergen Tag</button>

                            <label className="control-label">Tags</label>
                            {this.state.RecipeTags.map((tag, index) => {
                                if(!tag.IsAllergenTag) {
                                    return (
                                        <div key={index}>
                                            <input type="text" onChange={() => this.handleTagChange(event, index)} value={tag.Tag.TagName} />
                                            <button type="button" className="btn btn-danger" onClick={() => this.removeTag(index)}>X</button>
                                        </div>
                                    )
                                }
                            })}
                            <button type="button" className="btn btn-primary" onClick={this.addTag}>Add Tag</button>

                            <div className="form-group">
                                <input type="submit" value="Edit" className="btn btn-primary" />
                            </div>
                      </form>
                </div>
            )
        }

        onStepUrlChange = (event, index) => {
            console.log(event.target.files[0].name);
            this.setState(state => {
                const RecipeSteps = state.RecipeSteps;
                RecipeSteps[index].MediaFileUrl = "";
                RecipeSteps[index].MediaSelectedFile = event.target.files[0];

                return {
                    RecipeSteps
                }
            })
        }

        onStepMediaUpload = async (event, index) => {
            event.preventDefault();
            const file = this.state.RecipeSteps[index].MediaSelectedFile;

            const formData = new FormData();
            formData.append("formFile", file);
            formData.append("fileName", file.name);

            try {
                const { data: { fileUrl } } = await axios.post("/Recipes/FileUpload", formData);
                console.log(fileUrl);

                this.setState(state => {
                    const RecipeSteps = state.RecipeSteps;
                    RecipeSteps[index].MediaFileUrl = fileUrl.trim();
                    console.log(RecipeSteps);
                    return {
                        RecipeSteps
                    }
                });
            } catch(error) {
                alert("Error uploading step image");
            }
        }

        onMainMediaUpload = async (event) => {
            event.preventDefault();
            const file = this.state.MainSelectedFile;

            const formData = new FormData();
            formData.append("formFile", file);
            formData.append("fileName", file.name);

            try {
                const { data: { fileUrl } } = await axios.post("/Recipes/FileUpload", formData);
                console.log(fileUrl);

                this.setState({
                    MainMediaUrl: fileUrl.trim()
                });
            } catch(error) {
                alert("Error uploading image");
            }
        }

        onMainMediaUrlChange = (event) => {
            console.log(event.target.files[0].name)
            this.setState({
                MainMediaUrl: "",
                MainSelectedFile: event.target.files[0]
            })
        }

        constructor(props) {
            super(props);
            this.state = {
                Title: "",
                Description: "",
                UserId: "@Html.Raw(userId)",
                DurationInMins: 0,
                Calories: 0,
                ServingSize: 1,
                IsPublished: true,
                MainMediaUrl: "",
                MainSelectedFile: null,
                RecipeIngredients: [{
                    Ingredient: "",
                    Quantity: 0,
                    UnitOfMeasurement: "",
                }],
                RecipeSteps: [{
                    TextInstructions: "",
                    MediaFileUrl: "",
                    MediaSelectedFile: null,
                }],
                RecipeTags: [{
                    IsAllergenTag: true,
                    Tag: {
                        TagName: "",
                        Warning: "",
                    }
                }, {
                    IsAllergenTag: false,
                    Tag: {
                        TagName: "",
                        Warning: ""
                    }
                }],
            };
        }

        componentDidMount() {
            this.setState(state =>{
                var state = JSON.parse(JSON.stringify(@Html.Raw(recipe)));
                console.log(state);
                return {
                    ...state,
                }
            })
        }

        submitHandler = (event) => {
            event.preventDefault();
            const toSubmit = this.generateJson();
            console.log(toSubmit);
            this.postRecipe(toSubmit);
        }

        generateJson = () => {
            var RecipeSteps = this.state.RecipeSteps
                .filter(step => step.TextInstructions.trim() !== "")
                .map((step, index) => {
                    delete step.MediaSelectedFile;
                    return {
                        ...step, 
                        StepNumber: index + 1
                    }
                });
            
            var RecipeIngredients = this.state.RecipeIngredients
                .filter(ingredient => ingredient.Ingredient.trim() !== "");

            var RecipeTags = this.state.RecipeTags
                .filter(allergenTag => allergenTag.Tag.Warning.trim() !== "");

            var state = {...this.state};
            delete state.MainSelectedFile;
            const toSubmit = {
                ...state,
                RecipeSteps,
                RecipeIngredients,
                RecipeTags
            }
            return toSubmit;
        }

        generateAllergenTags = (event) => {
            event.preventDefault();
            const ingredient = [...this.state.RecipeIngredients];
            console.log(ingredient);
            this.fetchAllergenTags(ingredient, this.setAllergenTags);
        }

        fetchAllergenTags = (ingredient, callback) => {
            let xhr = new XMLHttpRequest();
            xhr.open("POST", "/Recipes/GenerateAllergenTag");
            xhr.setRequestHeader("Content-Type", "application/json; charset=utf8");

            xhr.setRequestHeader("RequestVerificationToken", 
                    document.getElementById('RequestVerificationToken').value);

            xhr.onreadystatechange = function () {
                if (this.readyState === XMLHttpRequest.DONE) {
                    // Get tags from flask ML
                    if (this.status === 200) {
                        const { tags } = JSON.parse(this.response);
                        console.log(tags);
                        callback(tags);
                    } else {
                        alert("Error generate tags");
                    }
                }
            };

            xhr.send(JSON.stringify(ingredient));
        }

        setAllergenTags = (tags) => {
            this.setState(state => {
                const RecipeTags = [...state.RecipeTags, ...JSON.parse(tags)]
                return {
                    RecipeTags
                }
            })
            console.log(this.state.RecipeTags);
        }

        removeAllergenTag = (index) => {
            this.setState(state => {
                const RecipeTags = state.RecipeTags;
                RecipeTags.splice(index, 1);
                return {
                    RecipeTags
                }
            })
        }

        addAllergenTag = () => {
            this.setState(state => {
                const RecipeTags = [...state.RecipeTags, {
                    IsAllergenTag: true,
                    Tag: {
                        TagName: "",
                        Warning: "",
                    }
                }];
                return {
                    RecipeTags
                }
            })
        }

        handleAllergenTagChange = (event, index) => {
            const newTag = event.target.value;
            this.setState(state => {
                const RecipeTags = state.RecipeTags;
                RecipeTags[index] = {
                    IsAllergenTag: true,
                    Tag: {
                        TagName: newTag,
                        Warning: newTag,
                    }
                };
                return {
                    RecipeTags
                }
            })
        }

        handleTagChange = (event, index) => {
            const newTag = event.target.value;
            this.setState(state => {
                const RecipeTags = state.RecipeTags;
                RecipeTags[index] = {
                    IsAllergenTag: false,
                    Tag: {
                        TagName: newTag,
                        Warning: newTag,
                    }
                }
                return {
                    RecipeTags
                }
            })
        }

        removeTag = (index) => {
            this.setState(state => {
                const RecipeTags = state.RecipeTags;
                RecipeTags.splice(index, 1);
                return {
                    RecipeTags
                }
            })
        }

        addTag = () => {
            this.setState(state => {
                const RecipeTags = [...state.RecipeTags, {
                    IsAllergenTag: false,
                    Tag: {
                        TagName: "",
                        Warning: "",
                    }
                }];
                return {
                    RecipeTags
                }
            })
        }

        postRecipe = (toSubmit) => {
            let xhr = new XMLHttpRequest();
            xhr.open("POST", `/Recipes/Edit/${this.state.RecipeId}`);
            xhr.setRequestHeader("Content-Type", "application/json; charset=utf8");

            xhr.setRequestHeader("RequestVerificationToken",
                    document.getElementById('RequestVerificationToken').value);

            xhr.onreadystatechange = function () {
                if (this.readyState === XMLHttpRequest.DONE) {
                    // Request for recipe list page if add recipe is successful
                    if (this.status === 200) {
                        var url = window.location.href;
                        var redirectUrl = url.split("/");
                        redirectUrl.splice(-2,2);
                        window.location.assign(redirectUrl.join("/"));
                    } else {
                        alert("Error editing recipe");
                    }
                }
            };

            xhr.send(JSON.stringify(toSubmit));
        }

        handleChange = (event) => {
            const { name, value } = event.target;
            this.setState({
                [name]: value
            });
        }

        addIngredient = () => {
            this.setState(state => {
                const RecipeIngredients = [...state.RecipeIngredients, {
                    Ingredient: "",
                    Quantity: 0,
                    UnitOfMeasurement: "",
                }]
                return {
                    RecipeIngredients,
                }
            })
        }

        removeIngredient = (index) => {
            this.setState(state => {
                const RecipeIngredients = state.RecipeIngredients;
                RecipeIngredients.splice(index, 1);
                return {
                    RecipeIngredients,
                }
            })
        }

        handleIngredientChange = (index) => {
            const Ingredient = document.getElementById(`ingredient-name-${index}`).value;
            const Quantity = document.getElementById(`ingredient-qty-${index}`).value;
            const Unit = document.getElementById(`ingredient-unit-${index}`).value;
            this.setState(state => {
                const RecipeIngredients = state.RecipeIngredients;
                RecipeIngredients[index] = {
                    Ingredient,
                    Quantity,
                    Unit
                }
                return {
                    RecipeIngredients
                };
            })
        }

        addStep = () => {
            this.setState(state => {
                const RecipeSteps = [...state.RecipeSteps, {
                    TextInstructions: "",
                    MediaFileUrl: "",
                    MediaSelectedFile: null,
                }];
                return {
                    RecipeSteps,
                }
            });
        }

        removeStep = (index) => {
            this.setState(state => {
                const RecipeSteps = state.RecipeSteps;
                RecipeSteps.splice(index, 1);
                return {
                    RecipeSteps,
                }
            });
        }

        handleStepChange = (event, index) => {
            const TextInstructions = event.target.value;
            this.setState(state => {
                const RecipeSteps = state.RecipeSteps;
                const oldStep = RecipeSteps[index]
                RecipeSteps[index] = {
                    ...oldStep,
                    TextInstructions
                }
                return {
                    RecipeSteps
                };
            })
        }
    }

    ReactDOM.render(<Edit />, document.querySelector("#edit"));
</script>